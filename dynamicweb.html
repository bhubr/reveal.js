<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Le web dynamique</title>

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/night.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- My own css -->
    <link rel="stylesheet" href="css/extra.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          <h4>Le web dynamique</h4>
          <p class="fragment">Dans la <a href="webserver.html">présentation précédente</a>, on a utilisé des serveurs web pour héberger des sites <em>statiques</em>, dont les pages sont lues depuis le disque dur, et envoyées telles quelles aux clients.</p>
          <p class="fragment">On va aborder ici les pages, générées dynamiquement <em>côté serveur</em>.</p>
        </section>
        <section>
          <h4>Pourquoi ?</h4>
          <p>Les fichiers HTML "statiques" sont très limités : l'information qu'ils présentent est figée.</p>
          <p class="fragment">De ce fait, avec le seul HTML, il est impossible de développer un moteur de recherche, un site marchand, ou même de traiter un simple formulaire de contact !</p>
        </section>
        <section>
          <h4>Comment ?</h4>
          <p>Si le HTML écrit "en dur" est insuffisant, la solution est de générer le HTML "à la demande".</p>
          <p class="fragment">Le plus souvent (mais pas obligatoirement), on va aller chercher des données dans une <em>base de données</em>.</p>
          <p class="fragment">Exemple : si un utilisateur entre un nom de produit dans un formulaire, on va chercher tous les produits correspondants dans la table des produits, et les afficher dans une liste.</p>
        </section>
        <section>
          <h4>Et concrètement ?</h4>
          <p>Les serveur web tels qu'Apache (et ses ancêtres) ne sont pas faits pour s'interfacer avec une base de données.</p>
          <p class="fragment">Lorsqu'on a voulu permettre la génération dynamique de HTML, il a fallu les interfacer (les faire communiquer) avec du code externe.</p>
          <p class="fragment">Cela a été rendu possible par l'apparition, en 1993, du standard CGI (<a href target="_blank" href="https://fr.wikipedia.org/wiki/Common_Gateway_Interface">Common Gateway Interface</a>).</p>
        </section>
        <section>
          <h4>Itinéraire d'une requête</h4>
          <div class="flex cgi">
            <div>
                <p class="fragment step-fade-in-then-out">
                    1. Le client (typiquement un navigateur web) émet une requête HTTP, qui arrive au serveur web.
                </p>
                <p class="fragment step-fade-in-then-out">
                  2. Le serveur web transmet les paramètres de la requête au programme externe (script CGI).
                </p>
                <p class="fragment step-fade-in-then-out">
                  3. Le programme externe émet une requête au serveur de bases de données (SQL <em> ou autre</em>).
                </p>
                <p class="fragment step-fade-in-then-out">
                  4. Le serveur de bases de données renvoie des données au programme.
                </p>
                <p class="fragment step-fade-in-then-out">
                  5. Le programme génère du contenu HTML, puis le renvoie au serveur web.
                </p>
                <p class="fragment step-fade-in-then-out">
                  6. Le serveur web renvoie le HTML généré, comme réponse à destination du client.
                </p>
                <!-- <p class="fragment"></p> -->
            </div>
            <div style="position:relative">
              <!-- <div style="position:absolute;top:33%;left:26%;width:0;height:30%;box-shadow: 0px 0px 21px 1px rgba(195,205,100,1);border:1px solid red;padding:0"></div> -->
              <img style="width:100%" src="images/stack-serveur-cgi.svg" alt="Stack Serveur" />
              <p style="font-size:70%;margin:0;text-align:right;color:#bbb"><em>BDD = Base De Données</em></p>
            </div>
          </div>
        </section>
        <section>
          <h4>Exemple de "pile serveur"</h4>
          <p>On vient de voir une architecture serveur : serveur web, langage externe, base de données, le tout fonctionnant sur un certain système d'exploitation.</p>
          <p class="fragment">On appelle cela une "pile serveur" (<em>server stack</em>), parce qu'elle est constituée d'un empilement de technologies différentes, chacune jouant un rôle bien défini.</p>
        </section>
        <section>
          <h4>La pile LAMP / WAMP</h4>
          <p>Une des piles serveurs les plus répandues est constituée de :</p>
          <ul>
            <li>Linux ou Windows</li>
            <li>Apache</li>
            <li>MySQL</li>
            <li>PHP</li>
          </ul>
          <p class="fragment">D'où le nom LAMP (Linux) ou WAMP (Windows).</p>
        </section>
        <section>
          <h4>Installation de PHP</h4>
          <p style="font-size: 76%"><em>Passez à la suite si PHP est déjà installé et configuré.</em></p>
          <pre><code>sudo add-apt-repository ppa:ondrej/php
sudo apt update
sudo apt install php7.2 php7.2-common php7.2-cli php7.2-fpm</code></pre>
          <p style="font-size: 76%">Un fichier à récupérer (via <code>wget</code>) et à copier dans le dossier de configuration de Nginx, après sauvegarde de l'original.</p>
          <pre><code style="font-size: 76%">sudo wget https://prez.wild31.com/dl/default
sudo mv /etc/nginx/sites-available/default /etc/nginx/sites-available/default.bak
sudo cp default /etc/nginx/sites-available/
sudo service nginx reload</code></pre>
        </section>
        <section>
          <h4>Hello World en PHP</h4>
          <ul class="list-small">
            <li>Coller ce code dans un fichier <code>hello.php</code>&nbsp;:<br>
              <code class="inline-code">sudo nano /var/www/html/hello.php</code>
            </li>
            <li><a href="http://localhost/hello.php">http://localhost/hello.php</a></li>
          </ul>
          <!-- <p>On peut mélanger HTML et code PHP...</p> -->
          <pre><code style="font-size: 76%">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;body&gt;
    &lt;?php echo &quot;Hello World&quot;; ?&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
        </section>
        <section>
          <h4>Comment ça fonctionne</h4>
          <ul class="list-small">
            <li>Ici, les étapes 3 et 4 du "cycle" expliqué précédemment (requête et réponse BDD) ne s'appliquent pas.</li>
            <li class="fragment">Quand le serveur reçoit une requête sur le fichier <code>hello.php</code>, il est configuré pour "comprendre" qu'il doit passer le contrôle à PHP, du fait de l'extension <code>.php</code> (étape 2 du cycle).</li>
            <li class="fragment">Dans le code, on mélange du HTML et du PHP (délimité par les tags <code>&lt;?php</code> et <code>?&gt;</code>).</li>
            <li class="fragment">Le HTML renvoyé au serveur (étape 5 du cycle) est la combinaison du HTML (laissé tel quel) et de tout ce que PHP écrit (<code>echo</code> pour afficher).</li>
          </ul>
        </section>
        <section>
          <h4>Exemple avec MySQL</h4>
          <p class="text-sm">Pré-requis : quête <a target="_blank" href="https://odyssey.wildcodeschool.fr/quests/363">SQL 0</a> (section "ajout de données")</p>
          <p class="text-sm">
            Dans le terminal, se placer dans le répertoire Downloads.
            <ul style="padding-left: 30px" class="list-small">
              <li>Y sauvegarder <a href="/dl/phpmysql.tar.gz">ce fichier</a>,</li>
              <li>le décompresser,</li>
              <li>déplacer le tout vers le répertoire de documents Apache/Nginx,</li>
              <li>exécuter le script <code>setup.sql</code> dans MySQL (password <code>root</code> requis)</li>
            </ul>
            <pre><code style="font-size: 76%">wget https://prez.wild31.com/dl/phpmysql.tar.gz
tar xvzf phpmysql.tar.gz
sudo mv phpmysql /var/www/html/
mysql -uroot -p < /var/www/html/phpmysql/setup.sql</code></pre>
          </p>
          <p class="text-sm fragment">Puis visiter <a target="_blank" href="http://localhost/phpmysql/employees.php">http://localhost/phpmysql/employees.php</a></p>
        </section>
        <section>
          <h4>Explication (rapide) du code</h4>
          <p class="text-sm">Ne cherche pas à tout comprendre en détail.</p>
          <p class="text-sm fragment">Récupérer le résultat d'un <code>SELECT</code> sur la table <code>employee</code>&nbsp;:</p>
          <pre class="fragment"><code style="font-size: 76%">$queryResult = $database->query(
  "SELECT firstname,lastname FROM employee{$where}"
);</code></pre>
          <p class="text-sm fragment">Créer des <code>&lt;li&gt;</code> à partir des résultats&nbsp;:</p>
<pre class="fragment"><code style="font-size: 76%">while ($row = $queryResult->fetch()) {
  echo '<li>' . $row['firstname'] . ' ' . $row['lastname'] . '</li>';
}</code></pre>
          <p class="text-sm fragment">Le <a target="_blank" href="view-source:http://localhost/phpmysql/employees.php">source</a> de la page web indique que tout le HTML est généré par PHP, côté serveur !</p>
        </section>
        <!-- <section>
          <h4>Afficher une liste en PHP</h4>
          <pre><code style="font-size: 76%">&#x3C;?php
$articles = [
  &#x22;Desktop Computer&#x22;,
  &#x22;Laptop Computer&#x22;,
  &#x22;Smartphone&#x22;
]; ?&#x3E;
&#x3C;!DOCTYPE html&#x3E;
&#x3C;html&#x3E;
  &#x3C;body&#x3E;
    &#x3C;ul&#x3E;
    &#x3C;?php
        // Boucle sur le tableau articles
        for($i = 0 ; $i &#x3C; count($articles) ; $i++) {
            // Concat&#xE9;nation en PHP (caract&#xE8;re . au lieu de + en JS)
            echo &#x27;&#x3C;li&#x3E;&#x27; . $articles[$i] . &#x27;&#x3C;/li&#x3E;&#x27;;
        }
    ?&#x3E;
    &#x3C;/ul&#x3E;
  &#x3C;/body&#x3E;
&#x3C;/html&#x3E;</code></pre>
        <ul class="list-small">
          <li><code class="inline-code">nano /var/www/html/store.php</code></li>
          <li><a href="http://localhost/store.php">http://localhost/store.php</a></li>
        </ul>
        </section>
        <section>
          <h4>PHP #6 - Afficher une liste filtrée</h4>
          <pre><code style="font-size: 76%">&#x3C;?php
$title = &#x22;My search engine&#x22;;
$apps = [
  &#x22;Google Tasks - todolist app&#x22;,
  &#x22;Todoist - todolist app&#x22;,
  &#x22;Evernote - todolist app&#x22;,
  &#x22;Waze - traffic app&#x22;,
  &#x22;Spotify - music app&#x22;,
  &#x22;Deezer - music app&#x22;,
  &#x22;Shazam - music app&#x22;
];
// V&#xE9;rifie la pr&#xE9;sence d&#x27;un param&#xE8;tre ?search=XYZ dans l&#x27;URL
$isSearching = isset($_GET[&#x27;search&#x27;]);

// Filtre les apps en fonction de la recherche
$results = ! $isSearching
    ? []
    : array_filter($apps, function($app) {
        // Convertit le nom d&#x27;app en minuscules
        $appLowerCase = strtolower($app);
        // Renvoie true si le nom d&#x27;app contient le terme recherch&#xE9;
        return strpos($appLowerCase, strtolower($_GET[&#x27;search&#x27;]));
    });
?&#x3E;
&#x3C;!DOCTYPE html&#x3E;
&#x3C;html&#x3E;
  &#x3C;body&#x3E;
    &#x3C;h1&#x3E;&#x3C;?php echo $title; ?&#x3E;&#x3C;/h1&#x3E;
    &#x3C;form&#x3E;
        &#x3C;input name=&#x22;search&#x22; /&#x3E;
        &#x3C;p&#x3E;&#x3C;em&#x3E;Essayer &#x22;music&#x22;, &#x22;todolist&#x22;&#x3C;/em&#x3E;&#x3C;/p&#x3E;
        &#x3C;button type=&#x22;submit&#x22;&#x3E;Rechercher&#x3C;/button&#x3E;
    &#x3C;/form&#x3E;
    &#x3C;ul&#x3E;
    &#x3C;?php
        if($isSearching) {
            // Boucle sur le tableau results
            foreach($results as $app) {
                // Concat&#xE9;nation en PHP (caract&#xE8;re . au lieu de + en JS)
                echo &#x27;&#x3C;li&#x3E;&#x27; . $app . &#x27;&#x3C;/li&#x3E;&#x27;;
            }
        }
    ?&#x3E;
    &#x3C;/ul&#x3E;
  &#x3C;/body&#x3E;
&#x3C;/html&#x3E;</code></pre>
        <ul class="list-small">
          <li><code class="inline-code">nano /var/www/html/search.php</code></li>
          <li><a href="http://localhost/store.php">http://localhost/search.php</a></li>
        </ul>
        </section> -->
        <section>
          <h4></h4>
        </section>
        <section><em>That's all, folks!</em></section>
      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
      // More info about config & dependencies:
      // - https://github.com/hakimel/reveal.js#configuration
      // - https://github.com/hakimel/reveal.js#dependencies
      Reveal.initialize({
        dependencies: [
          { src: 'plugin/markdown/marked.js' },
          { src: 'plugin/markdown/markdown.js' },
          { src: 'plugin/notes/notes.js', async: true },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
        ]
      });
    </script>
  </body>
</html>
